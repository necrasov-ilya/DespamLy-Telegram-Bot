"""
Информационные команды: /primer, /help, /start
"""
from __future__ import annotations

from telegram import Update
from telegram.constants import ParseMode
from telegram.ext import ContextTypes

from utils.logger import get_logger

LOGGER = get_logger(__name__)


async def cmd_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Команда /start - приветствие и начало работы."""
    if not update.effective_message or not update.effective_user:
        return
    
    username = update.effective_user.first_name
    
    message = (
        f"👋 Привет, <b>{username}</b>!\n\n"
        f"Я <b>DespamLy</b> — бот для защиты групповых чатов от спама.\n\n"
        f"<b>Что я умею:</b>\n"
        f"✅ Автоматически обнаруживать спам (ML-модели)\n"
        f"✅ Удалять спам-сообщения\n"
        f"✅ Банить спамеров\n"
        f"✅ Уведомлять владельца о детектах\n"
        f"✅ Статистика и аналитика\n\n"
        f"<b>Быстрый старт:</b>\n"
        f"1️⃣ Добавь меня в группу как администратора\n"
        f"2️⃣ Дай права на удаление сообщений и бан\n"
        f"3️⃣ Настрой защиту через /mychats\n\n"
        f"📖 Подробнее: /primer"
    )
    
    await update.effective_message.reply_html(message)


async def cmd_primer(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Команда /primer - полный экскурс по возможностям бота."""
    if not update.effective_message:
        return
    
    message = (
        "📖 <b>DespamLy — Полное руководство</b>\n\n"
        
        "━━━━━━━━━━━━━━━━━━━━\n"
        "<b>🎯 Основные возможности</b>\n"
        "━━━━━━━━━━━━━━━━━━━━\n\n"
        
        "<b>1. ML-детекция спама</b>\n"
        "• Автоматическое обнаружение спама с помощью машинного обучения\n"
        "• Анализ текста, ссылок, телефонов и паттернов\n"
        "• Точность: >95%\n\n"
        
        "<b>2. Режимы работы</b>\n"
        "🗑️ <b>Удаление спама</b> (рекомендуется)\n"
        "   → Удаляет спам, не банит пользователей\n\n"
        "⛔ <b>Удаление + бан</b> (агрессивный)\n"
        "   → Удаляет спам + банит при высокой уверенности\n\n"
        "🔍 <b>Только уведомления</b> (тестовый)\n"
        "   → Не удаляет, только отправляет уведомления\n\n"
        
        "<b>3. Модераторский канал</b>\n"
        "• Создай отдельный канал для уведомлений\n"
        "• Получай детекты в канале, а не в ЛС\n"
        "• Без канала доступен только режим 'Удаление спама'\n\n"
        
        "━━━━━━━━━━━━━━━━━━━━\n"
        "<b>🚀 Быстрый старт</b>\n"
        "━━━━━━━━━━━━━━━━━━━━\n\n"
        
        "<b>Шаг 1: Добавь бота в группу</b>\n"
        "• Открой настройки группы\n"
        "• Участники → Добавить участников\n"
        "• Найди @YourBotUsername\n\n"
        
        "<b>Шаг 2: Сделай администратором</b>\n"
        "Дай права:\n"
        "✅ Удалять сообщения\n"
        "✅ Банить пользователей\n\n"
        
        "<b>Шаг 3: Настрой защиту</b>\n"
        "• Напиши /mychats (можно прямо здесь)\n"
        "• Выбери свою группу\n"
        "• Нажми 'Активировать защиту'\n\n"
        
        "<b>Шаг 4 (опционально): Модераторский канал</b>\n"
        "• Создай канал в Telegram\n"
        "• Добавь меня в канал как администратора\n"
        "• В /mychats выбери 'Настроить модераторский канал'\n"
        "• Режимы 'Уведомления' и 'Удаление+бан' станут доступны\n\n"
        
        "━━━━━━━━━━━━━━━━━━━━\n"
        "<b>⚙️ Команды владельца</b>\n"
        "━━━━━━━━━━━━━━━━━━━━\n\n"
        
        "/mychats — Управление чатами\n"
        "   • Активировать/приостановить защиту\n"
        "   • Изменить режим работы\n"
        "   • Настроить модераторский канал\n"
        "   • Управление whitelist\n"
        "   • Статистика за 7 дней\n\n"
        
        "━━━━━━━━━━━━━━━━━━━━\n"
        "<b>🛡️ Команды для админов группы</b>\n"
        "━━━━━━━━━━━━━━━━━━━━\n\n"
        
        "/status — Статус защиты чата\n"
        "   • Текущий режим работы\n"
        "   • Пороги срабатывания\n"
        "   • Статистика за сегодня\n\n"
        
        "/pause — Приостановить защиту\n"
        "   • Временно отключает модерацию\n"
        "   • Бот не проверяет сообщения\n\n"
        
        "/resume — Возобновить защиту\n"
        "   • Включает модерацию обратно\n\n"
        
        "/test {текст} — Тестировать бота\n"
        "   • Проверить как бот оценивает текст\n"
        "   • Показывает scores всех фильтров\n"
        "   • Действия не выполняются\n\n"
        
        "━━━━━━━━━━━━━━━━━━━━\n"
        "<b>⭐ Дополнительные возможности</b>\n"
        "━━━━━━━━━━━━━━━━━━━━\n\n"
        
        "<b>Whitelist</b>\n"
        "• Доверенные пользователи\n"
        "• Их сообщения не проверяются\n"
        "• Добавить: кнопка в уведомлении о спаме\n\n"
        
        "<b>Настройка порогов</b>\n"
        "• meta_delete — порог удаления (85%)\n"
        "• meta_kick — порог бана (95%)\n"
        "• Настраивается через меню\n\n"
        
        "<b>Статистика</b>\n"
        "• Обработано сообщений\n"
        "• Обнаружено спама\n"
        "• Удалено сообщений\n"
        "• Забанено пользователей\n"
        "• По дням за последние 7 дней\n\n"
        
        "━━━━━━━━━━━━━━━━━━━━\n"
        "<b>🔒 Безопасность</b>\n"
        "━━━━━━━━━━━━━━━━━━━━\n\n"
        
        "• Не храним полный текст сообщений (GDPR)\n"
        "• Только SHA-256 хеш для аналитики\n"
        "• Rate limiting (защита от флуда)\n"
        "• PostgreSQL для надёжного хранения\n\n"
        
        "━━━━━━━━━━━━━━━━━━━━\n"
        "<b>❓ Частые вопросы</b>\n"
        "━━━━━━━━━━━━━━━━━━━━\n\n"
        
        "<b>Q: Бот удалил легитимное сообщение</b>\n"
        "A: Нажми 'Ham (ошибка)' в уведомлении.\n"
        "   Или добавь пользователя в whitelist.\n\n"
        
        "<b>Q: Можно ли настроить пороги?</b>\n"
        "A: Да! Через /mychats → настройки чата.\n"
        "   Рекомендуемые: delete=85%, kick=95%\n\n"
        
        "<b>Q: Почему недоступны режимы 'Уведомления' и 'Удаление+бан'?</b>\n"
        "A: Нужен модераторский канал.\n"
        "   Создай канал → добавь меня → настрой в /mychats\n\n"
        
        "<b>Q: Как работает rate limiting?</b>\n"
        "A: Более 30 сообщений в минуту = флуд.\n"
        "   Сообщения удаляются без анализа.\n\n"
        
        "━━━━━━━━━━━━━━━━━━━━\n\n"
        
        "💬 Поддержка: @YourSupportUsername\n"
        "📄 Исходный код: github.com/your/repo\n\n"
        
        "<i>Версия 2.0 | Production Ready</i>"
    )
    
    await update.effective_message.reply_html(message)


async def cmd_help(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Команда /help - краткая справка."""
    if not update.effective_message:
        return
    
    message = (
        "📚 <b>Краткая справка</b>\n\n"
        
        "<b>Команды владельца:</b>\n"
        "/mychats — Управление чатами\n"
        "/primer — Полное руководство\n\n"
        
        "<b>Команды для админов группы:</b>\n"
        "/status — Статус защиты\n"
        "/pause — Приостановить\n"
        "/resume — Возобновить\n"
        "/test {текст} — Тестировать\n\n"
        
        "💡 <b>Быстрый старт:</b>\n"
        "1. Добавь меня в группу\n"
        "2. Сделай администратором\n"
        "3. Напиши /mychats\n\n"
        
        "📖 Подробнее: /primer"
    )
    
    await update.effective_message.reply_html(message)
